<div class="account-container">
  <!-- Header -->
  <div class="account-header">
    <div class="header-content">
      <h1 class="page-title">
        <i class="pi pi-user"></i>
        Profil użytkownika
      </h1>
      <p class="page-subtitle">Zarządzaj swoim kontem i ustawieniami</p>
    </div>
    <p-button
      icon="pi pi-refresh"
      label="Odśwież"
      styleClass="p-button-outlined"
      (onClick)="onRefreshData()"
      [loading]="isLoading"
    ></p-button>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-content">
    <div class="grid">
      <div class="col-12 lg:col-4">
        <p-card>
          <p-skeleton height="200px"></p-skeleton>
        </p-card>
      </div>
      <div class="col-12 lg:col-8">
        <p-card>
          <p-skeleton height="200px"></p-skeleton>
        </p-card>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div *ngIf="!isLoading && userProfile" class="account-content">
    <div class="grid">
      <!-- Profile Summary Card -->
      <div class="col-12 lg:col-4">
        <p-card styleClass="profile-summary-card">
          <ng-template pTemplate="header">
            <div class="profile-header">
              <div class="avatar-section">
                <p-avatar
                  [image]="userProfile.avatar"
                  size="xlarge"
                  shape="circle"
                  styleClass="profile-avatar"
                ></p-avatar>
                <p-fileUpload
                  mode="basic"
                  accept="image/*"
                  maxFileSize="1000000"
                  chooseLabel="Zmień avatar"
                  styleClass="avatar-upload"
                  (onUpload)="onAvatarUpload($event)"
                ></p-fileUpload>
              </div>
              <div class="profile-info">
                <h2>{{ userProfile.name }} {{ userProfile.lastname }}</h2>
                <p class="email">{{ userProfile.email }}</p>
                <p-badge
                  [value]="getRoleLabel(userProfile.role)"
                  [styleClass]="getRoleBadgeClass(userProfile.role)"
                ></p-badge>
              </div>
            </div>
          </ng-template>

          <div class="profile-details">
            <div class="detail-item" *ngIf="userProfile.phone">
              <i class="pi pi-phone"></i>
              <span>{{ userProfile.phone }}</span>
            </div>
            <div class="detail-item" *ngIf="userProfile.address">
              <i class="pi pi-map-marker"></i>
              <span>{{ userProfile.address }}</span>
            </div>
            <div class="detail-item" *ngIf="userProfile.dateOfBirth">
              <i class="pi pi-calendar"></i>
              <span>{{ formatDateOnly(userProfile.dateOfBirth) }}</span>
            </div>
            <div class="detail-item" *ngIf="userProfile.lastLogin">
              <i class="pi pi-clock"></i>
              <span
                >Ostatnie logowanie:
                {{ formatDate(userProfile.lastLogin) }}</span
              >
            </div>
          </div>

          <!-- Role-specific Information -->
          <p-divider></p-divider>

          <div class="role-specific-info">
            <!-- Student Info -->
            <div
              *ngIf="userProfile.role === UserRole.STUDENT"
              class="student-info"
            >
              <h4><i class="pi pi-graduation-cap"></i> Informacje ucznia</h4>
              <div class="info-grid">
                <div class="info-item" *ngIf="userProfile.studentClass">
                  <label>Klasa:</label>
                  <span>{{ userProfile.studentClass }}</span>
                </div>
                <div class="info-item" *ngIf="userProfile.studentNumber">
                  <label>Numer w dzienniku:</label>
                  <span>{{ userProfile.studentNumber }}</span>
                </div>
              </div>
            </div>

            <!-- Teacher Info -->
            <div
              *ngIf="userProfile.role === UserRole.TEACHER"
              class="teacher-info"
            >
              <h4><i class="pi pi-book"></i> Informacje nauczyciela</h4>
              <div class="subjects-list" *ngIf="userProfile.teacherSubjects">
                <label>Przedmioty:</label>
                <div class="subjects">
                  <p-tag
                    *ngFor="let subject of userProfile.teacherSubjects"
                    [value]="subject"
                    severity="info"
                  ></p-tag>
                </div>
              </div>
            </div>

            <!-- Parent Info -->
            <div
              *ngIf="userProfile.role === UserRole.PARENT"
              class="parent-info"
            >
              <h4><i class="pi pi-users"></i> Informacje rodzica</h4>
              <div class="children-list" *ngIf="userProfile.parentChildren">
                <label>Dzieci:</label>
                <div class="children">
                  <p-tag
                    *ngFor="let child of userProfile.parentChildren"
                    [value]="child"
                    severity="info"
                  ></p-tag>
                </div>
              </div>
            </div>
          </div>

          <!-- Bio Section -->
          <div *ngIf="userProfile.bio" class="bio-section">
            <p-divider></p-divider>
            <h4><i class="pi pi-info-circle"></i> O mnie</h4>
            <p>{{ userProfile.bio }}</p>
          </div>
        </p-card>
      </div>

      <!-- Main Content Area -->
      <div class="col-12 lg:col-8">
        <!-- Statistics Card -->
        <p-card *ngIf="statistics" styleClass="statistics-card mb-4">
          <ng-template pTemplate="header">
            <div class="card-header">
              <h3><i class="pi pi-chart-bar"></i> Statystyki</h3>
            </div>
          </ng-template>

          <div class="statistics-grid">
            <!-- Student Statistics -->
            <div
              *ngIf="userProfile.role === UserRole.STUDENT"
              class="stats-content"
            >
              <div class="stat-item">
                <div class="stat-value">{{ statistics.totalGrades }}</div>
                <div class="stat-label">Oceny</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">{{ statistics.averageGrade }}</div>
                <div class="stat-label">Średnia</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">{{ statistics.attendanceRate }}%</div>
                <div class="stat-label">Frekwencja</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">
                  {{ statistics.completedAssignments }}/{{
                    statistics.totalAssignments
                  }}
                </div>
                <div class="stat-label">Zadania</div>
              </div>
            </div>

            <!-- Teacher Statistics -->
            <div
              *ngIf="userProfile.role === UserRole.TEACHER"
              class="stats-content"
            >
              <div class="stat-item">
                <div class="stat-value">{{ statistics.totalStudents }}</div>
                <div class="stat-label">Uczniowie</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">{{ statistics.totalClasses }}</div>
                <div class="stat-label">Klasy</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">{{ statistics.gradedAssignments }}</div>
                <div class="stat-label">Ocenione prace</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">{{ statistics.pendingGrades }}</div>
                <div class="stat-label">Do oceny</div>
              </div>
            </div>

            <!-- Parent Statistics -->
            <div
              *ngIf="userProfile.role === UserRole.PARENT"
              class="stats-content"
            >
              <div class="stat-item">
                <div class="stat-value">{{ statistics.totalChildren }}</div>
                <div class="stat-label">Dzieci</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">{{ statistics.averageGrade }}</div>
                <div class="stat-label">Średnia ocen</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">{{ statistics.upcomingEvents }}</div>
                <div class="stat-label">Nadchodzące wydarzenia</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">{{ statistics.unreadMessages }}</div>
                <div class="stat-label">Nieprzeczytane wiadomości</div>
              </div>
            </div>

            <!-- Admin Statistics -->
            <div
              *ngIf="userProfile.role === UserRole.ADMIN"
              class="stats-content"
            >
              <div class="stat-item">
                <div class="stat-value">{{ statistics.totalUsers }}</div>
                <div class="stat-label">Użytkownicy</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">{{ statistics.totalStudents }}</div>
                <div class="stat-label">Uczniowie</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">{{ statistics.totalTeachers }}</div>
                <div class="stat-label">Nauczyciele</div>
              </div>
              <div class="stat-item">
                <div class="stat-value">{{ statistics.systemUptime }}%</div>
                <div class="stat-label">Dostępność systemu</div>
              </div>
            </div>
          </div>
        </p-card>

        <!-- Settings Tabs -->
        <p-tabView styleClass="settings-tabs">
          <!-- Profile Settings Tab -->
          <p-tabPanel header="Edytuj profil" leftIcon="pi pi-user">
            <form [formGroup]="profileForm" (ngSubmit)="onUpdateProfile()">
              <div class="form-grid">
                <div class="form-row">
                  <p-floatLabel>
                    <input
                      id="name"
                      type="text"
                      pInputText
                      formControlName="name"
                      [class.ng-invalid]="isFieldInvalid(profileForm, 'name')"
                    />
                    <label for="name">Imię *</label>
                  </p-floatLabel>
                  <small
                    *ngIf="isFieldInvalid(profileForm, 'name')"
                    class="p-error"
                  >
                    {{ getFieldError(profileForm, 'name') }}
                  </small>
                </div>

                <div class="form-row">
                  <p-floatLabel>
                    <input
                      id="lastname"
                      type="text"
                      pInputText
                      formControlName="lastname"
                      [class.ng-invalid]="
                        isFieldInvalid(profileForm, 'lastname')
                      "
                    />
                    <label for="lastname">Nazwisko *</label>
                  </p-floatLabel>
                  <small
                    *ngIf="isFieldInvalid(profileForm, 'lastname')"
                    class="p-error"
                  >
                    {{ getFieldError(profileForm, 'lastname') }}
                  </small>
                </div>

                <div class="form-row">
                  <p-floatLabel>
                    <input
                      id="phone"
                      type="tel"
                      pInputText
                      formControlName="phone"
                      [class.ng-invalid]="isFieldInvalid(profileForm, 'phone')"
                    />
                    <label for="phone">Telefon</label>
                  </p-floatLabel>
                  <small
                    *ngIf="isFieldInvalid(profileForm, 'phone')"
                    class="p-error"
                  >
                    {{ getFieldError(profileForm, 'phone') }}
                  </small>
                </div>

                <div class="form-row">
                  <p-floatLabel>
                    <input
                      id="address"
                      type="text"
                      pInputText
                      formControlName="address"
                    />
                    <label for="address">Adres</label>
                  </p-floatLabel>
                </div>

                <div class="form-row">
                  <p-floatLabel>
                    <textarea
                      id="bio"
                      pInputTextarea
                      formControlName="bio"
                      rows="4"
                      [class.ng-invalid]="isFieldInvalid(profileForm, 'bio')"
                    ></textarea>
                    <label for="bio">O mnie</label>
                  </p-floatLabel>
                  <small
                    *ngIf="isFieldInvalid(profileForm, 'bio')"
                    class="p-error"
                  >
                    {{ getFieldError(profileForm, 'bio') }}
                  </small>
                </div>
              </div>

              <div class="form-actions">
                <p-button
                  type="submit"
                  label="Zapisz zmiany"
                  icon="pi pi-save"
                  [loading]="isUpdatingProfile"
                  [disabled]="profileForm.invalid"
                ></p-button>
              </div>
            </form>
          </p-tabPanel>

          <!-- Password Change Tab -->
          <p-tabPanel header="Zmień hasło" leftIcon="pi pi-lock">
            <form [formGroup]="passwordForm" (ngSubmit)="onChangePassword()">
              <div class="form-grid">
                <div class="form-row">
                  <p-floatLabel>
                    <p-password
                      id="currentPassword"
                      formControlName="currentPassword"
                      [feedback]="false"
                      [toggleMask]="true"
                      [class.ng-invalid]="
                        isFieldInvalid(passwordForm, 'currentPassword')
                      "
                    ></p-password>
                    <label for="currentPassword">Aktualne hasło *</label>
                  </p-floatLabel>
                  <small
                    *ngIf="isFieldInvalid(passwordForm, 'currentPassword')"
                    class="p-error"
                  >
                    {{ getFieldError(passwordForm, 'currentPassword') }}
                  </small>
                </div>

                <div class="form-row">
                  <p-floatLabel>
                    <p-password
                      id="newPassword"
                      formControlName="newPassword"
                      [feedback]="true"
                      [toggleMask]="true"
                      [class.ng-invalid]="
                        isFieldInvalid(passwordForm, 'newPassword')
                      "
                    ></p-password>
                    <label for="newPassword">Nowe hasło *</label>
                  </p-floatLabel>
                  <small
                    *ngIf="isFieldInvalid(passwordForm, 'newPassword')"
                    class="p-error"
                  >
                    {{ getFieldError(passwordForm, 'newPassword') }}
                  </small>
                </div>

                <div class="form-row">
                  <p-floatLabel>
                    <p-password
                      id="confirmPassword"
                      formControlName="confirmPassword"
                      [feedback]="false"
                      [toggleMask]="true"
                      [class.ng-invalid]="
                        isFieldInvalid(passwordForm, 'confirmPassword') ||
                        passwordForm.hasError('passwordMismatch')
                      "
                    ></p-password>
                    <label for="confirmPassword">Potwierdź hasło *</label>
                  </p-floatLabel>
                  <small
                    *ngIf="
                      isFieldInvalid(passwordForm, 'confirmPassword') ||
                      passwordForm.hasError('passwordMismatch')
                    "
                    class="p-error"
                  >
                    {{
                      getFieldError(passwordForm, 'confirmPassword') ||
                        'Hasła nie są identyczne'
                    }}
                  </small>
                </div>
              </div>

              <div class="form-actions">
                <p-button
                  type="submit"
                  label="Zmień hasło"
                  icon="pi pi-lock"
                  [loading]="isChangingPassword"
                  [disabled]="passwordForm.invalid"
                ></p-button>
              </div>
            </form>
          </p-tabPanel>

          <!-- Account Settings Tab -->
          <p-tabPanel header="Ustawienia konta" leftIcon="pi pi-cog">
            <div class="account-settings">
              <p-panel header="Informacje o koncie" [toggleable]="true">
                <div class="account-info">
                  <div class="info-item">
                    <label>Data utworzenia konta:</label>
                    <span>{{ formatDate(userProfile.accountCreated!) }}</span>
                  </div>
                  <div class="info-item">
                    <label>Ostatnie logowanie:</label>
                    <span>{{ formatDate(userProfile.lastLogin!) }}</span>
                  </div>
                  <div class="info-item">
                    <label>Adres email:</label>
                    <span>{{ userProfile.email }}</span>
                  </div>
                  <div class="info-item">
                    <label>Rola w systemie:</label>
                    <span>{{ getRoleLabel(userProfile.role) }}</span>
                  </div>
                </div>
              </p-panel>

              <p-panel
                header="Zarządzanie kontem"
                [toggleable]="true"
                styleClass="mt-4"
              >
                <div class="danger-zone">
                  <h4 class="danger-title">
                    <i class="pi pi-exclamation-triangle"></i>
                    Strefa niebezpieczna
                  </h4>
                  <p class="danger-description">
                    Poniższe akcje są nieodwracalne. Upewnij się, że rozumiesz
                    konsekwencje przed ich wykonaniem.
                  </p>
                  <p-button
                    label="Usuń konto"
                    icon="pi pi-trash"
                    styleClass="p-button-danger"
                    (onClick)="onDeleteAccount()"
                  ></p-button>
                </div>
              </p-panel>
            </div>
          </p-tabPanel>
        </p-tabView>
      </div>
    </div>
  </div>
</div>

<!-- Toast Messages -->
<p-toast></p-toast>

<!-- Confirmation Dialog -->
<p-confirmDialog></p-confirmDialog>
