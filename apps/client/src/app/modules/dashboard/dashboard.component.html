<div class="dashboard-container">
  <!-- Header Section -->
  <div class="dashboard-header">
    <div class="welcome-section">
      <h1 class="page-title">
        <i class="pi pi-home"></i>
        {{ greeting() }}, {{ userName() }}!
      </h1>
      <p class="page-subtitle">Witaj w swoim panelu GradeFlow</p>
    </div>

    <div class="header-actions">
      <p-button
        icon="pi pi-refresh"
        [text]="true"
        [rounded]="true"
        pTooltip="Odśwież dane"
        (onClick)="refreshDashboard()"
      >
      </p-button>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading()" class="loading-content">
    <div class="grid">
      <div class="col-12 md:col-8">
        <div class="grid">
          <!-- Quick Stats Skeletons -->
          <div class="col-12 md:col-6 lg:col-3" *ngFor="let i of [1, 2, 3, 4]">
            <p-card>
              <p-skeleton height="60px"></p-skeleton>
            </p-card>
          </div>

          <!-- Charts Skeletons -->
          <div class="col-12 md:col-6">
            <p-card>
              <p-skeleton height="200px"></p-skeleton>
            </p-card>
          </div>
          <div class="col-12 md:col-6">
            <p-card>
              <p-skeleton height="200px"></p-skeleton>
            </p-card>
          </div>
        </div>
      </div>

      <div class="col-12 md:col-4">
        <p-card>
          <p-skeleton height="300px"></p-skeleton>
        </p-card>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div *ngIf="!isLoading() && dashboardData()" class="dashboard-content">
    <div class="grid">
      <!-- Left Column - Main Content -->
      <div class="col-12 md:col-8">
        <!-- Quick Stats -->
        <div class="grid quick-stats">
          <!-- Overall Average -->
          <div class="col-12 md:col-6 lg:col-3">
            <p-card class="stat-card average-card">
              <div class="stat-content">
                <div class="stat-icon">
                  <i class="pi pi-star-fill"></i>
                </div>
                <div class="stat-details">
                  <h3>
                    {{
                      dashboardData()?.gradeStatistics?.overallAverage || 0
                        | number : '1.2-2'
                    }}
                  </h3>
                  <p>Średnia ogólna</p>
                  <p-progressBar
                    [value]="
                      getAverageProgress(
                        dashboardData()?.gradeStatistics?.overallAverage || 0
                      )
                    "
                    [showValue]="false"
                    styleClass="progress-small"
                  >
                  </p-progressBar>
                </div>
              </div>
            </p-card>
          </div>

          <!-- Total Grades -->
          <div class="col-12 md:col-6 lg:col-3">
            <p-card class="stat-card grades-card">
              <div class="stat-content">
                <div class="stat-icon">
                  <i class="pi pi-list"></i>
                </div>
                <div class="stat-details">
                  <h3>
                    {{ dashboardData()?.gradeStatistics?.totalGrades || 0 }}
                  </h3>
                  <p>Wszystkich ocen</p>
                  <small>w tym semestrze</small>
                </div>
              </div>
            </p-card>
          </div>

          <!-- Current Lesson -->
          <div class="col-12 md:col-6 lg:col-3">
            <p-card
              class="stat-card lesson-card"
              [class.active]="dashboardData()?.currentLesson"
            >
              <div class="stat-content">
                <div class="stat-icon">
                  <i class="pi pi-clock"></i>
                </div>
                <div class="stat-details">
                  <h3
                    *ngIf="dashboardData()?.currentLesson; else noCurrentLesson"
                  >
                    {{ formatTime(dashboardData()?.currentLesson?.startTime) }}
                  </h3>
                  <ng-template #noCurrentLesson>
                    <h3>--:--</h3>
                  </ng-template>
                  <p>Aktualna lekcja</p>
                  <small *ngIf="dashboardData()?.currentLesson">
                    {{ dashboardData()?.currentLesson?.subjectName }}
                  </small>
                  <small *ngIf="!dashboardData()?.currentLesson">
                    Brak zajęć
                  </small>
                </div>
              </div>
            </p-card>
          </div>

          <!-- Next Lesson -->
          <div class="col-12 md:col-6 lg:col-3">
            <p-card class="stat-card next-lesson-card">
              <div class="stat-content">
                <div class="stat-icon">
                  <i class="pi pi-calendar"></i>
                </div>
                <div class="stat-details">
                  <h3 *ngIf="dashboardData()?.nextLesson; else noNextLesson">
                    {{ formatTime(dashboardData()?.nextLesson?.startTime) }}
                  </h3>
                  <ng-template #noNextLesson>
                    <h3>--:--</h3>
                  </ng-template>
                  <p>Następna lekcja</p>
                  <small *ngIf="dashboardData()?.nextLesson">
                    {{ dashboardData()?.nextLesson?.subjectName }}
                  </small>
                  <small *ngIf="!dashboardData()?.nextLesson">
                    Brak zajęć
                  </small>
                </div>
              </div>
            </p-card>
          </div>
        </div>

        <!-- Charts Section -->
        <div class="grid charts-section">
          <!-- Grades Trend Chart -->
          <div class="col-12 md:col-6">
            <p-card>
              <ng-template pTemplate="header">
                <div class="card-header">
                  <h3><i class="pi pi-chart-line"></i> Trend ocen</h3>
                </div>
              </ng-template>

              <div class="chart-container" *ngIf="gradesTrendChart()">
                <p-chart
                  type="line"
                  [data]="gradesTrendChart()?.data"
                  [options]="gradesTrendChart()?.options"
                  height="200px"
                >
                </p-chart>
              </div>
            </p-card>
          </div>

          <!-- Subject Averages Chart -->
          <div class="col-12 md:col-6">
            <p-card>
              <ng-template pTemplate="header">
                <div class="card-header">
                  <h3><i class="pi pi-chart-pie"></i> Średnie przedmiotów</h3>
                </div>
              </ng-template>

              <div class="chart-container" *ngIf="subjectAveragesChart()">
                <p-chart
                  type="doughnut"
                  [data]="subjectAveragesChart()?.data"
                  [options]="subjectAveragesChart()?.options"
                  height="200px"
                >
                </p-chart>
              </div>
            </p-card>
          </div>
        </div>

        <!-- Recent Grades -->
        <div class="recent-grades-section">
          <p-card>
            <ng-template pTemplate="header">
              <div class="card-header">
                <h3><i class="pi pi-star"></i> Ostatnie oceny</h3>
                <p-button
                  label="Zobacz wszystkie"
                  [text]="true"
                  size="small"
                  (onClick)="navigateToGrades()"
                >
                </p-button>
              </div>
            </ng-template>

            <div
              class="recent-grades-list"
              *ngIf="dashboardData()?.recentGrades?.length; else noRecentGrades"
            >
              <div
                class="grade-item"
                *ngFor="let grade of dashboardData()?.recentGrades"
              >
                <div class="grade-info">
                  <div class="grade-subject">
                    <strong>{{ grade.subjectName }}</strong>
                    <small>{{ formatDate(grade.date) }}</small>
                  </div>
                  <div class="grade-details">
                    <p-tag
                      [value]="grade.grade_value.toString()"
                      [severity]="getGradeSeverity(grade.grade_value)"
                      [rounded]="true"
                    >
                    </p-tag>
                    <span class="grade-weight"
                      >Waga: {{ grade.grade_weight }}</span
                    >
                  </div>
                </div>
                <div class="grade-comment" *ngIf="grade.comment">
                  <small>{{ grade.comment }}</small>
                </div>
              </div>
            </div>

            <ng-template #noRecentGrades>
              <div class="empty-state">
                <i class="pi pi-star"></i>
                <p>Brak ostatnich ocen</p>
                <small>Oceny pojawią się tutaj po ich dodaniu</small>
              </div>
            </ng-template>
          </p-card>
        </div>
      </div>

      <!-- Right Column - Sidebar -->
      <div class="col-12 md:col-4">
        <!-- Notifications -->
        <div class="notifications-section">
          <p-card>
            <ng-template pTemplate="header">
              <div class="card-header">
                <h3><i class="pi pi-bell"></i> Powiadomienia</h3>
                <p-badge
                  [value]="dashboardData()?.notifications?.length || 0"
                  severity="info"
                >
                </p-badge>
              </div>
            </ng-template>

            <div
              class="notifications-list"
              *ngIf="
                dashboardData()?.notifications?.length;
                else noNotifications
              "
            >
              <div
                class="notification-item"
                *ngFor="let notification of dashboardData()?.notifications"
              >
                <div class="notification-icon">
                  <i
                    [class]="notification.icon"
                    [class.text-blue-500]="notification.type === 'info'"
                    [class.text-orange-500]="notification.type === 'warning'"
                    [class.text-green-500]="notification.type === 'success'"
                    [class.text-red-500]="notification.type === 'error'"
                  >
                  </i>
                </div>
                <div class="notification-content">
                  <h4>{{ notification.title }}</h4>
                  <p>{{ notification.message }}</p>
                  <small>{{ notification.time }}</small>
                </div>
              </div>
            </div>

            <ng-template #noNotifications>
              <div class="empty-state">
                <i class="pi pi-bell"></i>
                <p>Brak powiadomień</p>
                <small>Powiadomienia pojawią się tutaj</small>
              </div>
            </ng-template>
          </p-card>
        </div>

        <!-- Today's Timetable -->
        <div class="today-timetable-section">
          <p-card>
            <ng-template pTemplate="header">
              <div class="card-header">
                <h3><i class="pi pi-calendar"></i> Plan na dziś</h3>
                <p-button
                  label="Pełny plan"
                  [text]="true"
                  size="small"
                  (onClick)="navigateToTimetable()"
                >
                </p-button>
              </div>
            </ng-template>

            <div
              class="today-lessons"
              *ngIf="
                dashboardData()?.todayTimetable?.length;
                else noTodayLessons
              "
            >
              <div
                class="lesson-item"
                *ngFor="let lesson of dashboardData()?.todayTimetable"
                [class.current-lesson]="
                  dashboardData()?.currentLesson?.id === lesson.id
                "
              >
                <div class="lesson-time">
                  <strong>{{ formatTime(lesson.startTime) }}</strong>
                  <small>{{ formatTime(lesson.endTime) }}</small>
                </div>
                <div class="lesson-details">
                  <h4>{{ lesson.subjectName }}</h4>
                  <p>{{ lesson.teacherName }}</p>
                  <small>Sala {{ lesson.room }}</small>
                </div>
              </div>
            </div>

            <ng-template #noTodayLessons>
              <div class="empty-state">
                <i class="pi pi-calendar"></i>
                <p>Brak zajęć na dziś</p>
                <small>Miłego dnia wolnego!</small>
              </div>
            </ng-template>
          </p-card>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions-section">
          <p-card>
            <ng-template pTemplate="header">
              <div class="card-header">
                <h3><i class="pi pi-bolt"></i> Szybkie akcje</h3>
              </div>
            </ng-template>

            <div class="quick-actions">
              <p-button
                label="Moje oceny"
                icon="pi pi-star"
                [outlined]="true"
                styleClass="w-full mb-2"
                (onClick)="navigateToGrades()"
              >
              </p-button>

              <p-button
                label="Plan zajęć"
                icon="pi pi-calendar"
                [outlined]="true"
                styleClass="w-full mb-2"
                (onClick)="navigateToTimetable()"
              >
              </p-button>

              <p-button
                label="Mój profil"
                icon="pi pi-user"
                [outlined]="true"
                styleClass="w-full"
                (onClick)="navigateToAccount()"
              >
              </p-button>
            </div>
          </p-card>
        </div>
      </div>
    </div>
  </div>

  <!-- Error State -->
  <div *ngIf="!isLoading() && !dashboardData()" class="error-state">
    <p-card>
      <div class="empty-state">
        <i class="pi pi-exclamation-triangle"></i>
        <h3>Błąd ładowania danych</h3>
        <p>Nie udało się załadować danych dashboard</p>
        <p-button
          label="Spróbuj ponownie"
          icon="pi pi-refresh"
          (onClick)="refreshDashboard()"
        >
        </p-button>
      </div>
    </p-card>
  </div>
</div>
